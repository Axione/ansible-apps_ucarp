---
- name: "Check for ucarp binary"
  stat:
    path: "/usr/sbin/ucarp"
  changed_when: false
  register: ucarp_binary

- when: not ucarp_binary.stat.exists
  block:
    - name: "Install ucarp"
      package:
        name: ["ucarp", "iputils-arping"]
        state: present

    - name: "Create config directory"
      file:
        path: /etc/ucarp/
        state: directory
        mode: '0755'

- name: "Create init file for ucarp"
  template:
    src: ucarp.service
    dest: /etc/systemd/system/ucarp.service
    mode: '0644'
  notify:
    - restart ucarp

- name: "Copy vip up and down scripts"
  copy:
    src: "{{ item }}"
    dest: "/etc/ucarp/{{ item }}"
    mode: '0755'
  with_items:
    - vip-down.sh
    - vip-up.sh
  notify:
    - restart ucarp

- name: "Enable ucarp service"
  systemd:
    name: ucarp
    enabled: true
    state: started
    daemon_reload: true
